# =============================================================================
# ARTIFACTORY WITH DELETE PROTECTION - UPDATED VERSION
# =============================================================================
# Generated on: Mon Sep 29 13:13:15 CEST 2025
# Based on latest JFrog Artifactory nginx configuration from:
# https://github.com/jfrog/charts/blob/master/stable/artifactory/files/nginx-artifactory-conf.yaml
# 
# This embeds the nginx config directly in Helm values
# So Helm templates are processed correctly

nginx:
  enabled: true
  artifactoryConf: |
    # Security-enhanced nginx configuration for Artifactory
    # Based on latest JFrog configuration with DELETE protection added
    
    # ============================================================
    # DELETE PROTECTION CONFIGURATION
    # ============================================================
    # Map to identify IPs allowed for DELETE operations
    map $remote_addr $delete_allowed {
        default 0;  # By default, ALL IPs are BLOCKED for DELETE
        
        # AUTHORIZED IPs - CUSTOMIZE HERE
        172.16.1.99 1;    # Admin IP #1
        172.16.1.119 1;   # Admin IP #2 (current)
        172.16.1.100 1;   # Range coverage
        172.16.1.101 1;
        172.16.1.102 1;
        172.16.1.110 1;
        172.16.1.111 1;
        172.16.1.112 1;
        172.16.1.115 1;
        172.16.1.118 1;
        172.16.1.120 1;
        
        # Add other admin IPs here:
        # 192.168.1.100 1;  # Example admin IP
        # 10.0.0.50 1;      # Another admin IP
    }

    # Map to identify blocked DELETE requests
    map $request_method:$delete_allowed $delete_blocked {
        default 0;
        DELETE:0 1;
    }

    {{- if .Values.nginx.https.enabled }}
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_certificate  {{ .Values.nginx.persistence.mountPath }}/ssl/tls.crt;
    ssl_certificate_key  {{ .Values.nginx.persistence.mountPath }}/ssl/tls.key;
    ssl_session_cache shared:SSL:1m;
    ssl_prefer_server_ciphers   on;
    {{- end }}
    
    upstream router {
      server {{ include "artifactory.fullname" . }}:{{ .Values.artifactory.externalPort }};
      keepalive 320;
      keepalive_requests 10000;
    }
    
    upstream routerInternal {
      server {{ include "artifactory.fullname" . }}:{{ .Values.router.internalPort }};
      keepalive 320;
      keepalive_requests 10000;
    }
    
    upstream artifactory {
      server {{ include "artifactory.fullname" . }}:{{ .Values.artifactory.externalArtifactoryPort }};
      keepalive 320;
      keepalive_requests 10000;
    }
    
    ## server configuration
    server {
    {{- if .Values.nginx.internalPortHttps }}
    {{- if .Values.nginx.singleStackIPv6Cluster }}
    listen [::]:{{ .Values.nginx.internalPortHttps }} ssl;
    # Specialized logs for DELETE security
    access_log /var/opt/jfrog/nginx/logs/delete_blocked.log combined if=$delete_blocked;

    {{- else -}}
    listen {{ .Values.nginx.internalPortHttps }} ssl;
    {{- end }}
    {{- else -}}
    {{- if .Values.nginx.https.enabled }}
    {{- if .Values.nginx.singleStackIPv6Cluster }}
    listen [::]:{{ .Values.nginx.https.internalPort }} ssl;
    {{- else -}}
    listen {{ .Values.nginx.https.internalPort }} ssl;
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if .Values.nginx.internalPortHttp }}
    {{- if .Values.nginx.singleStackIPv6Cluster }}
    listen [::]:{{ .Values.nginx.internalPortHttp }};
    {{- else -}}
    listen {{ .Values.nginx.internalPortHttp }};
    {{- end }}
    {{- else -}}
    {{- if .Values.nginx.http.enabled }}
    {{- if .Values.nginx.singleStackIPv6Cluster }}
    listen [::]:{{ .Values.nginx.http.internalPort }};
    {{- else -}}
    listen {{ .Values.nginx.http.internalPort }};
    {{- end }}
    {{- end }}
    {{- end }}
    server_name ~(?<repo>.+)\.{{ include "artifactory.fullname" . }} {{ include "artifactory.fullname" . }}
    {{ tpl (include "artifactory.nginx.hosts" .) . }};
    
    if ($http_x_forwarded_proto = '') {
      set $http_x_forwarded_proto  $scheme;
    }
    set $host_port {{ .Values.nginx.https.externalPort }};
    if ( $scheme = "http" ) {
      set $host_port {{ .Values.nginx.http.externalPort }};
    }
    ## Application specific logs
    ## access_log /var/log/nginx/artifactory-access.log timing;
    ## error_log /var/log/nginx/artifactory-error.log;
    rewrite ^/artifactory/?$ / redirect;
    if ( $repo != "" ) {
      rewrite ^/(v1|v2)/(.*) /artifactory/api/docker/$repo/$1/$2 break;
    }
    chunked_transfer_encoding on;
    client_max_body_size 0;
    
    location / {
        # =================================================================
        # DELETE PROTECTION - ARTIFACTORY API
        # =================================================================
        location ~ ^/artifactory/api/ {
          # DELETE verification
          set $delete_check 0;
          if ($request_method = DELETE) {
            set $delete_check 1;
          }
          if ($delete_allowed = 1) {
            set $delete_check 0;
          }
          if ($delete_check = 1) {
            add_header Content-Type "application/json" always;
            return 403 '{"error": "DELETE_OPERATION_BLOCKED", "status": 403, "message": "DELETE operations are restricted for security reasons.", "client_ip": "$remote_addr", "timestamp": "$time_iso8601"}';
          }
          
          # Security headers
          add_header X-Delete-Protection "enabled" always;
          
          # Standard proxy configuration
          proxy_read_timeout  900;
          proxy_pass_header   Server;
          proxy_cookie_path   ~*^/.* /;
          proxy_pass          http://artifactory;
          proxy_set_header    Connection "";
          proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host;
          proxy_set_header    X-Forwarded-Port  $server_port;
          proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
          proxy_set_header    Host              $http_host;
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        }

        # =================================================================
        # DELETE PROTECTION - MODERN UI API
        # =================================================================
        location ~ ^/ui/api/v1/ui/admin/repositories/.*/delete {
          # DELETE verification
          set $ui_api_delete_check 0;
          if ($request_method = DELETE) {
            set $ui_api_delete_check 1;
          }
          if ($delete_allowed = 1) {
            set $ui_api_delete_check 0;
          }
          if ($ui_api_delete_check = 1) {
            add_header Content-Type "application/json" always;
            return 403 '{"error": "UI_API_DELETE_BLOCKED", "status": 403, "message": "DELETE operations through modern UI API are restricted.", "client_ip": "$remote_addr", "timestamp": "$time_iso8601"}';
          }
          
          # Security headers
          add_header X-UI-API-Protection "enabled" always;
          
          # Proxy to UI API
          proxy_read_timeout  900;
          proxy_pass_header   Server;
          proxy_cookie_path   ~*^/.* /;
          proxy_pass          http://router;
          proxy_set_header    Connection "";
          proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host;
          proxy_set_header    X-Forwarded-Port  $server_port;
          proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
          proxy_set_header    Host              $http_host;
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        }

      proxy_read_timeout  900;
      proxy_pass_header   Server;
      proxy_cookie_path   ~*^/.* /;
      proxy_pass          {{ include "artifactory.scheme" . }}://router/;
      proxy_set_header    Connection "";
      {{- if .Values.nginx.service.ssloffload}}
      {{- if .Values.nginx.service.ssloffloadForceHttps}}
      proxy_set_header    X-JFrog-Override-Base-Url https://$host;
      proxy_set_header    X-Forwarded-Proto https;
      {{- else }}
      proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host;
      proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
      {{- end }}
      {{- else if or (eq (int .Values.nginx.https.internalPort) 80) (eq (int .Values.nginx.https.externalPort) 443)}}
      proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host;
      proxy_set_header    X-Forwarded-Port  $server_port;
      proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
      {{- else }}
      proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host:$host_port;
      proxy_set_header    X-Forwarded-Port  $server_port;
      proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
      {{- end }}
      proxy_set_header    Host              $http_host;
      proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
      {{- if .Values.nginx.disableProxyBuffering}}
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering off;
      {{- end }}
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
      location /artifactory/ {
        if ( $request_uri ~ ^/artifactory/(.*)$ ) {
          proxy_pass       http://artifactory/artifactory/$1;
        }
        proxy_pass         http://artifactory/artifactory/;
      }
      location /pipelines/ {
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Host $http_host;
        {{- if .Values.router.tlsEnabled }}
        proxy_pass  https://routerInternal;
        {{- else }}
        proxy_pass  http://routerInternal;
        {{- end }}
      }
    }
